((e,t)=>{"use strict";class s{constructor(){this.widgetState={},this.isRestoring=!1,this.init()}init(){this.bindEvents(),this.registerElementorHooks(),this.startPollingFallback(),this.restoreCachedSpreadsheetDelayed()}bindEvents(){const t=e(document);t.on("click",".fdbgp-create-spreadsheet",(e=>{e.preventDefault(),this.createSpreadsheet(e.currentTarget)})),t.on("click",".fdbgp-update-sheet",(e=>{e.preventDefault(),this.updateSheetHeaders(!1,e.currentTarget)})),t.on("change",".elementor-control-fdbgp_sheet_list select",(t=>{this.onSheetChange(e(t.currentTarget))})),t.on("change",".elementor-control-fdbgp_spreadsheetid select",(t=>{this.onSpreadsheetChange(e(t.currentTarget))})),t.on("change","[data-setting='fdbgp_spreadsheetid']",(t=>{this.cacheSpreadsheetSelection(e(t.currentTarget))})),t.on("change","[data-setting='fdbgp_sheet_list']",(t=>{this.cacheSheetSelection(e(t.currentTarget))}))}collectSettings(t){const s={};return t.find("input, select, textarea").each(((t,n)=>{const a=e(n).data("setting");a&&(s[a]=e(n).val())})),{spreadsheetId:s.fdbgp_spreadsheetid||"",sheetList:s.fdbgp_sheet_list||"",sheetName:s.fdbgp_sheet_name||"",newSheetName:s.fdbgp_new_sheet_tab_name||"",spreadsheetName:s.fdbgp_new_spreadsheet_name||"",sheetHeaders:s.fdbgp_sheet_headers||[]}}showError(e,t){e.stop(!0,!0).removeClass("elementor-panel-alert-success").addClass("elementor-panel-alert-danger").css({opacity:1}).html(t).show()}showSuccess(e,t){e.removeClass("elementor-panel-alert-danger").addClass("elementor-panel-alert-success").html(t).show().delay(1e4).fadeOut()}updateSheetHeaders(t=!1,s){if(!s)return;const n=e(s),a=n.closest(".elementor-panel"),r=n.find(".elementor-button-text"),o=a.find("#fdbgp-update-message"),i=n.data("original-text")||r.text();n.data("original-text",i);const d=this.collectSettings(a);if(!d.spreadsheetId||"new"===d.spreadsheetId)return this.showError(o,"Please select a Spreadsheet first");if("create_new_tab"===d.sheetList&&!d.newSheetName)return this.showError(o,"Please enter a New Sheet Tab Name");n.prop("disabled",!0),r.text("Updating...");let l=d.sheetHeaders;try{if("undefined"!=typeof elementor&&elementor.getPanelView){const e=elementor.getPanelView().getCurrentPageView();if(e&&e.model){const t=e.model.get("settings").get("form_fields");l&&Array.isArray(l)&&(l=l.map((e=>{const s={user_ip:"User IP",user_agent:"User Agent",page_url:"Page URL",submission_date:"Submission Date"};if(s[e])return s[e];if(t&&t.findWhere){const s=t.findWhere({custom_id:e});if(s){const t=s.get("field_label");return t&&""!==t.trim()?t:e}}return e})))}}}catch(e){console.error("FDBGP: Error resolving header labels:",e)}e.post(ajaxurl,{action:"fdbgp_update_sheet_headers",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:d.spreadsheetId,sheet_name:d.sheetList,new_sheet_name:d.newSheetName,headers:l,confirm_overwrite:t?"true":"false"}).done((t=>{const{success:n,data:r}=t;if(n&&r.confirm_needed)confirm(r.message)&&this.updateSheetHeaders(!0,s);else if(n){if(this.showSuccess(o,r.message),"create_new_tab"===d.sheetList&&r.sheet_name){const t=a.find("[data-setting='fdbgp_sheet_list']");t.html("<option>Loading...</option>"),e.post(ajaxurl,{action:"fdbgp_get_sheets",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:d.spreadsheetId}).done((e=>{if(e.success&&e.data.sheets){t.empty(),Object.entries(e.data.sheets).forEach((([e,s])=>{t.append(new Option(s,e))})),t.val(r.sheet_name).trigger("change"),this.saveWidgetState(r.sheet_name);try{const e=elementor.getPanelView()?.getCurrentPageView?.();e?.model?.setSetting&&e.model.setSetting("fdbgp_sheet_list",r.sheet_name)}catch(e){console.error("Error updating Elementor model:",e)}}}))}}else this.showError(o,r.message||"Unknown error")})).fail((()=>{this.showError(o,"Server error")})).always((()=>{n.prop("disabled",!1),r.text(i)}))}createSpreadsheet(t){const s=e(t),n=s.closest(".elementor-panel"),a=s.find(".elementor-button-text"),r=n.find("#fdbgp-message"),o=this.collectSettings(n),i=a.text();if(!o.spreadsheetName)return this.showError(r,"Please enter a Spreadsheet Name");if(!o.sheetName)return this.showError(r,"Please enter a Sheet Tab Name");if(!o.sheetHeaders.length)return this.showError(r,"Please select at least one Sheet Header");s.prop("disabled",!0),a.text("Creating...");let d=o.sheetHeaders;try{if("undefined"!=typeof elementor&&elementor.getPanelView){const e=elementor.getPanelView().getCurrentPageView();if(e&&e.model){const t=e.model.get("settings").get("form_fields");d&&Array.isArray(d)&&(d=d.map((e=>{const s={user_ip:"User IP",user_agent:"User Agent",page_url:"Page URL",submission_date:"Submission Date"};if(s[e])return s[e];if(t&&t.findWhere){const s=t.findWhere({custom_id:e});if(s){const t=s.get("field_label");return t&&""!==t.trim()?t:e}}return e})))}}}catch(e){console.error("FDBGP: Error resolving header labels:",e)}e.post(ajaxurl,{action:"fdbgp_create_spreadsheet",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_name:o.spreadsheetName,sheet_name:o.sheetName,headers:d}).done((t=>{const{success:s,data:n}=t;s?(this.cacheCreatedSpreadsheet(n),this.showSuccess(r,n.message||"Spreadsheet created"),setTimeout((()=>{const t=e("[data-setting='fdbgp_spreadsheetid']");if(t.length){if(!t.find(`option[value="${n.spreadsheet_id}"]`).length){const e=t.find("option[value='new']").remove();t.append(new Option(n.spreadsheet_name,n.spreadsheet_id)),t.append(e)}n.sheet_name&&e("[data-setting='fdbgp_sheet_list']").data("auto-select",n.sheet_name),t.val(n.spreadsheet_id).change()}}),2e3)):this.showError(r,n.message||"Unknown error")})).fail((()=>{this.showError(r,"Server error")})).always((()=>{s.prop("disabled",!1),a.text(i)}))}checkSheetContent(t){const s=t.val(),n=t.closest(".elementor-panel"),a=n.find("[data-setting='fdbgp_spreadsheetid']").val(),r=n.find("#fdbgp-update-message");if(!s||"create_new_tab"===s||!a||"new"===a)return r.hide();e.post(ajaxurl,{action:"fdbgp_check_sheet_headers",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:a,sheet_name:s}).done((e=>{e.success&&e.data.has_content?this.showError(r,e.data.message):r.hide()}))}onSheetChange(e){const s=e.val(),n=e.closest(".elementor-panel").find("[data-setting='fdbgp_spreadsheetid']").val();try{const e=elementor.getPanelView()?.getCurrentPageView?.(),a=e?.model?.get("id");a&&(t.fdbgpWidgetState||(t.fdbgpWidgetState={}),s&&"create_new_tab"!==s?(t.fdbgpWidgetState[a]={sheet:s,spreadsheet:n},e.model.setSetting&&(e.model.setSetting("fdbgp_sheet_list",s),n&&e.model.setSetting("fdbgp_spreadsheetid",n),e.model.trigger("change"))):"create_new_tab"===s&&delete t.fdbgpWidgetState[a]?.sheet)}catch(e){}this.saveWidgetState(s),this.checkSheetContent(e)}onSpreadsheetChange(e){if("new"===e.val()){const t=e.closest(".elementor-panel");t.find("[data-setting='fdbgp_new_spreadsheet_name']").val(""),t.find("[data-setting='fdbgp_sheet_name']").val("")}try{const e=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");e&&t.fdbgpWidgetState?.[e]&&delete t.fdbgpWidgetState[e].sheet}catch(e){}this.clearWidgetState(),this.loadSheets(e),this.checkSheetContent(e)}loadSheets(t){const s=t.val();if(!s||"new"===s)return;const n=t.closest(".elementor-panel").find("[data-setting='fdbgp_sheet_list']");n.html("<option>Loading...</option>"),e.post(ajaxurl,{action:"fdbgp_get_sheets",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:s}).done((e=>{if(!e.success)return;n.empty(),Object.entries(e.data.sheets).forEach((([e,t])=>{n.append(new Option(t,e))}));const t=n.data("auto-select");if(t)n.val(t).removeData("auto-select"),this.saveWidgetState(t);else try{const e=elementor.getPanelView()?.getCurrentPageView?.().model,t=e?.getSetting("fdbgp_sheet_list");t&&"create_new_tab"!==t&&(n.val(t),this.saveWidgetState(t))}catch(e){}n.trigger("change")}))}getCacheKey(){try{const e=elementor.config.document.id||"default",t=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");return t?`fdbgp_cached_spreadsheet_${e}_${t}`:`fdbgp_cached_spreadsheet_${e}`}catch(e){return"fdbgp_cached_spreadsheet_default"}}cacheCreatedSpreadsheet(e){const t=this.getCacheKey();localStorage.setItem(t,JSON.stringify({id:e.spreadsheet_id,name:e.spreadsheet_name,sheet_name:e.sheet_name||""}))}cacheSpreadsheetSelection(e){const t=e.val();if(!t||"new"===t)return;const s=this.getCacheKey();localStorage.setItem(s,JSON.stringify({id:t,name:e.find("option:selected").text(),sheet_name:""}))}cacheSheetSelection(e){const t=e.val();if(!t||"create_new_tab"===t)return;const s=this.getCacheKey(),n=localStorage.getItem(s);if(n){const e=JSON.parse(n);e.sheet_name=t,localStorage.setItem(s,JSON.stringify(e))}}restoreCachedSpreadsheetDelayed(){setTimeout((()=>this.restoreCachedSpreadsheet()),2e3)}restoreCachedSpreadsheet(){const t=this.getCacheKey(),s=localStorage.getItem(t);if(!s)return;const n=JSON.parse(s),a=e("[data-setting='fdbgp_spreadsheetid']");if(!a.val()){if(!a.find(`option[value="${n.id}"]`).length){const e=a.find('option[value="new"]').remove();a.append(new Option(n.name,n.id)).append(e)}a.val(n.id).trigger("change"),n.sheet_name&&setTimeout((()=>{const t=e("[data-setting='fdbgp_sheet_list']");t.find(`option[value="${n.sheet_name}"]`).length>0&&t.val(n.sheet_name).trigger("change")}),1500)}}saveWidgetState(e){try{const t=elementor.getPanelView().getCurrentPageView().model.get("id");this.widgetState[t]=e}catch(e){}}clearWidgetState(){this.widgetState={}}registerElementorHooks(){elementor.hooks.addAction("panel/open_editor/widget",(e=>{setTimeout((()=>{const t=e.$el.find("[data-setting='fdbgp_spreadsheetid']"),s=e.$el.find("[data-setting='fdbgp_sheet_list']"),n=t.val(),a=s.val();if(n&&""!==n||a&&""!==a)n&&"new"!==n&&(s.find("option").length<=2?t.trigger("change"):this.checkSheetContent(s));else{const e=this.getCacheKey(),n=localStorage.getItem(e);if(n)try{const e=JSON.parse(n);if(e.id&&0===t.find(`option[value="${e.id}"]`).length){const s=t.find('option[value="new"]');s.remove();const n=document.createElement("option");n.value=e.id,n.text=e.name,t.append(n),t.append(s)}e.id&&(e.sheet_name&&s.data("auto-select",e.sheet_name),t.val(e.id).trigger("change"))}catch(e){console.log("FDBGP: Error restoring from cache:",e)}}}),1e3)})),elementor.channels?.editor&&elementor.channels.editor.on("change",(()=>{setTimeout((()=>{if(this.isRestoring)return;const s=e(".elementor-control-fdbgp_sheet_list select:visible"),n=e(".elementor-control-fdbgp_spreadsheetid select:visible");if(s.length&&n.length)try{const e=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");let a=t.fdbgpWidgetState?.[e];if(!a){const e=this.getCacheKey(),t=localStorage.getItem(e);if(t)try{const e=JSON.parse(t);a={spreadsheet:e.id,sheet:e.sheet_name}}catch(e){}}if(a){const e=n.val();s.val();if((!e||""===e)&&a.spreadsheet){if(0===n.find(`option[value="${a.spreadsheet}"]`).length){const e=localStorage.getItem(this.getCacheKey());if(e){const t=JSON.parse(e),s=n.find('option[value="new"]');s.remove();const a=document.createElement("option");a.value=t.id,a.text=t.name,n.append(a),n.append(s)}}return this.isRestoring=!0,a.sheet&&s.data("auto-select",a.sheet),n.val(a.spreadsheet).trigger("change"),void setTimeout((()=>{this.isRestoring=!1}),1e3)}if(a.sheet&&s.val()!==a.sheet){const e=s.find(`option[value="${a.sheet}"]`).length;!e&&n.val()?(this.isRestoring=!0,s.data("auto-select",a.sheet),n.trigger("change"),setTimeout((()=>{this.isRestoring=!1}),1e3)):e&&s.val(a.sheet).trigger("change")}}}catch(e){console.error("FDBGP: Error in change handler:",e),this.isRestoring=!1}}),300)}));const s=()=>{const e=this.getCacheKey();localStorage.removeItem(e)};"undefined"!=typeof $e&&$e.commands?$e.commands.on("run:after",((e,t)=>{t?.startsWith("document/save/")&&s()})):elementor.channels?.editor&&elementor.channels.editor.on("saved",s)}startPollingFallback(){const t=performance.now(),s=setInterval((()=>{const n=e(".elementor-control-fdbgp_spreadsheetid select:visible"),a=e(".elementor-control-fdbgp_sheet_list select:visible");n.length&&a.length&&n.val()&&(clearInterval(s),n.trigger("change")),performance.now()-t>2e4&&clearInterval(s)}),1e3)}}e(t).on("load",(()=>{t.FDBGP_Editor=new s})),e(t).on("load",(()=>{if("undefined"!=typeof elementor&&elementor.modules&&elementor.modules.controls){const t=elementor.modules.controls.BaseData.extend({onReady:function(){this.ui.select.length>0&&this.ui.select.select2({placeholder:"Select fields",allowClear:!0,width:"100%"}),this.updateOptions(),this.container.settings.has("form_fields")&&this.listenTo(this.container.settings.get("form_fields"),"add remove change",this.updateOptions)},updateOptions:function(){const t=this.container.settings.get("form_fields"),s=this.ui.select,n=this.getControlValue(),a=this.model.get("options");s.empty(),t&&t.each((e=>{const t=e.get("custom_id");let n=e.get("field_label");n||(n=t);const a=`${n} (${t})`;s.append(new Option(a,t,!1,!1))})),a&&e.each(a,((e,t)=>{s.append(new Option(t,e,!1,!1))})),n&&s.val(n),s.trigger("change")},onBeforeDestroy:function(){this.ui.select.data("select2")&&this.ui.select.select2("destroy")}});elementor.addControlView("fdbgp_dynamic_select2",t)}}))})(jQuery,window);