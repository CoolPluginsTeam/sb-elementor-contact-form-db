((e,t)=>{"use strict";class s{constructor(){this.widgetState={},this.isRestoring=!1,this.init()}init(){this.bindEvents(),this.registerElementorHooks(),this.startPollingFallback(),this.restoreCachedSpreadsheetDelayed()}bindEvents(){const t=e(document);t.on("click",".fdbgp-create-spreadsheet",(e=>{e.preventDefault(),this.createSpreadsheet(e.currentTarget)})),t.on("click",".fdbgp-update-sheet",(e=>{e.preventDefault(),this.updateSheetHeaders(!1,e.currentTarget)})),t.on("change",".elementor-control-fdbgp_sheet_list select",(t=>{this.onSheetChange(e(t.currentTarget))})),t.on("change",".elementor-control-fdbgp_spreadsheetid select",(t=>{this.onSpreadsheetChange(e(t.currentTarget))})),t.on("change","[data-setting='fdbgp_spreadsheetid']",(t=>{this.cacheSpreadsheetSelection(e(t.currentTarget))})),t.on("change","[data-setting='fdbgp_sheet_list']",(t=>{this.cacheSheetSelection(e(t.currentTarget))}))}collectSettings(t){const s={};return t.find("input, select, textarea").each(((t,a)=>{const n=e(a).data("setting");n&&(s[n]=e(a).val())})),{spreadsheetId:s.fdbgp_spreadsheetid||"",sheetList:s.fdbgp_sheet_list||"",sheetName:s.fdbgp_sheet_name||"",newSheetName:s.fdbgp_new_sheet_tab_name||"",spreadsheetName:s.fdbgp_new_spreadsheet_name||"",sheetHeaders:s.fdbgp_sheet_headers||[]}}showError(e,t){e.stop(!0,!0).removeClass("elementor-panel-alert-success").addClass("elementor-panel-alert-danger").css({opacity:1}).html(t).show()}showSuccess(e,t){e.removeClass("elementor-panel-alert-danger").addClass("elementor-panel-alert-success").html(t).show().delay(1e4).fadeOut()}updateSheetHeaders(t=!1,s){if(!s)return;const a=e(s),n=a.closest(".elementor-panel"),r=a.find(".elementor-button-text"),o=n.find("#fdbgp-update-message"),i=a.data("original-text")||r.text();a.data("original-text",i);const d=this.collectSettings(n);if(!d.spreadsheetId||"new"===d.spreadsheetId)return this.showError(o,"Please select a Spreadsheet first");if("create_new_tab"===d.sheetList&&!d.newSheetName)return this.showError(o,"Please enter a New Sheet Tab Name");a.prop("disabled",!0),r.text("Updating...");let l=d.sheetHeaders;try{if("undefined"!=typeof elementor&&elementor.getPanelView){const e=elementor.getPanelView().getCurrentPageView();if(e&&e.model){const t=e.model.get("settings").get("form_fields");l&&Array.isArray(l)&&(l=l.map((e=>{const s={user_ip:"User IP",user_agent:"User Agent",page_url:"Page URL",submission_date:"Submission Date"};if(s[e])return s[e];if(t&&t.findWhere){const s=t.findWhere({custom_id:e});if(s){const t=s.get("field_label");return t&&""!==t.trim()?t:e}}return e})))}}}catch(e){console.error("FDBGP: Error resolving header labels:",e)}e.post(ajaxurl,{action:"fdbgp_update_sheet_headers",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:d.spreadsheetId,sheet_name:d.sheetList,new_sheet_name:d.newSheetName,headers:l,confirm_overwrite:t?"true":"false"}).done((t=>{const{success:a,data:r}=t;if(a&&r.confirm_needed)confirm(r.message)&&this.updateSheetHeaders(!0,s);else if(a){if(this.showSuccess(o,r.message),"create_new_tab"===d.sheetList&&r.sheet_name){const t=n.find("[data-setting='fdbgp_sheet_list']");t.html("<option>Loading...</option>"),e.post(ajaxurl,{action:"fdbgp_get_sheets",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:d.spreadsheetId}).done((e=>{if(e.success&&e.data.sheets){t.empty(),Object.entries(e.data.sheets).forEach((([e,s])=>{t.append(new Option(s,e))})),t.val(r.sheet_name).trigger("change"),this.saveWidgetState(r.sheet_name);try{const e=elementor.getPanelView()?.getCurrentPageView?.();e?.model?.setSetting&&e.model.setSetting("fdbgp_sheet_list",r.sheet_name)}catch(e){console.error("Error updating Elementor model:",e)}}}))}}else this.showError(o,r.message||"Unknown error")})).fail((()=>{this.showError(o,"Server error")})).always((()=>{a.prop("disabled",!1),r.text(i)}))}createSpreadsheet(t){const s=e(t),a=s.closest(".elementor-panel"),n=s.find(".elementor-button-text"),r=a.find("#fdbgp-message"),o=this.collectSettings(a),i=n.text();if(!o.spreadsheetName)return this.showError(r,"Please enter a Spreadsheet Name");if(!o.sheetName)return this.showError(r,"Please enter a Sheet Tab Name");if(!o.sheetHeaders.length)return this.showError(r,"Please select at least one Sheet Header");s.prop("disabled",!0),n.text("Creating...");let d=o.sheetHeaders;try{if("undefined"!=typeof elementor&&elementor.getPanelView){const e=elementor.getPanelView().getCurrentPageView();if(e&&e.model){const t=e.model.get("settings").get("form_fields");d&&Array.isArray(d)&&(d=d.map((e=>{const s={user_ip:"User IP",user_agent:"User Agent",page_url:"Page URL",submission_date:"Submission Date"};if(s[e])return s[e];if(t&&t.findWhere){const s=t.findWhere({custom_id:e});if(s){const t=s.get("field_label");return t&&""!==t.trim()?t:e}}return e})))}}}catch(e){console.error("FDBGP: Error resolving header labels:",e)}e.post(ajaxurl,{action:"fdbgp_create_spreadsheet",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_name:o.spreadsheetName,sheet_name:o.sheetName,headers:d}).done((t=>{const{success:s,data:a}=t;s?(this.cacheCreatedSpreadsheet(a),this.showSuccess(r,a.message||"Spreadsheet created"),setTimeout((()=>{const t=e("[data-setting='fdbgp_spreadsheetid']");if(t.length){if(!t.find(`option[value="${a.spreadsheet_id}"]`).length){const e=t.find("option[value='new']").remove();t.append(new Option(a.spreadsheet_name,a.spreadsheet_id)),t.append(e)}a.sheet_name&&e("[data-setting='fdbgp_sheet_list']").data("auto-select",a.sheet_name),t.val(a.spreadsheet_id).change()}}),2e3)):this.showError(r,a.message||"Unknown error")})).fail((()=>{this.showError(r,"Server error")})).always((()=>{s.prop("disabled",!1),n.text(i)}))}checkSheetContent(t){const s=t.val(),a=t.closest(".elementor-panel"),n=a.find("[data-setting='fdbgp_spreadsheetid']").val(),r=a.find("#fdbgp-update-message");if(!s||"create_new_tab"===s||!n||"new"===n)return r.hide();e.post(ajaxurl,{action:"fdbgp_check_sheet_headers",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:n,sheet_name:s}).done((e=>{e.success&&e.data.has_content?this.showError(r,e.data.message):r.hide()}))}onSheetChange(e){const s=e.val(),a=e.closest(".elementor-panel").find("[data-setting='fdbgp_spreadsheetid']").val();try{const e=elementor.getPanelView()?.getCurrentPageView?.(),n=e?.model?.get("id");n&&(t.fdbgpWidgetState||(t.fdbgpWidgetState={}),s&&"create_new_tab"!==s?(t.fdbgpWidgetState[n]={sheet:s,spreadsheet:a},e.model.setSetting&&(e.model.setSetting("fdbgp_sheet_list",s),a&&e.model.setSetting("fdbgp_spreadsheetid",a),e.model.trigger("change"))):"create_new_tab"===s&&delete t.fdbgpWidgetState[n]?.sheet)}catch(e){}this.saveWidgetState(s),this.checkSheetContent(e)}onSpreadsheetChange(e){if("new"===e.val()){const t=e.closest(".elementor-panel");t.find("[data-setting='fdbgp_new_spreadsheet_name']").val(""),t.find("[data-setting='fdbgp_sheet_name']").val("")}try{const e=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");e&&t.fdbgpWidgetState?.[e]&&delete t.fdbgpWidgetState[e].sheet}catch(e){}this.clearWidgetState(),this.loadSheets(e),this.checkSheetContent(e)}loadSheets(t){const s=t.val();if(!s||"new"===s)return;const a=t.closest(".elementor-panel").find("[data-setting='fdbgp_sheet_list']");a.html("<option>Loading...</option>"),e.post(ajaxurl,{action:"fdbgp_get_sheets",_nonce:elementorCommon.config.ajax.nonce,spreadsheet_id:s}).done((e=>{if(!e.success)return;a.empty(),Object.entries(e.data.sheets).forEach((([e,t])=>{a.append(new Option(t,e))}));const t=a.data("auto-select");if(t)a.val(t).removeData("auto-select"),this.saveWidgetState(t);else try{const t=elementor.getPanelView()?.getCurrentPageView?.().model,s=t?.getSetting("fdbgp_sheet_list");s&&"create_new_tab"!==s&&e.data.sheets&&Object.prototype.hasOwnProperty.call(e.data.sheets,s)&&(a.val(s),this.saveWidgetState(s))}catch(e){}a.trigger("change")}))}getCacheKey(){try{const e=elementor.config.document.id||"default",t=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");return t?`fdbgp_cached_spreadsheet_${e}_${t}`:`fdbgp_cached_spreadsheet_${e}`}catch(e){return"fdbgp_cached_spreadsheet_default"}}cacheCreatedSpreadsheet(e){const t=this.getCacheKey();localStorage.setItem(t,JSON.stringify({id:e.spreadsheet_id,name:e.spreadsheet_name,sheet_name:e.sheet_name||""}))}cacheSpreadsheetSelection(e){const t=e.val();if(!t||"new"===t)return;const s=this.getCacheKey();localStorage.setItem(s,JSON.stringify({id:t,name:e.find("option:selected").text(),sheet_name:""}))}cacheSheetSelection(e){const t=e.val();if(!t||"create_new_tab"===t)return;const s=this.getCacheKey(),a=localStorage.getItem(s);if(a){const e=JSON.parse(a);e.sheet_name=t,localStorage.setItem(s,JSON.stringify(e))}}restoreCachedSpreadsheetDelayed(){setTimeout((()=>this.restoreCachedSpreadsheet()),2e3)}restoreCachedSpreadsheet(){const t=this.getCacheKey(),s=localStorage.getItem(t);if(!s)return;const a=JSON.parse(s),n=e("[data-setting='fdbgp_spreadsheetid']");if(!n.val()){if(!n.find(`option[value="${a.id}"]`).length){const e=n.find('option[value="new"]').remove();n.append(new Option(a.name,a.id)).append(e)}n.val(a.id).trigger("change"),a.sheet_name&&setTimeout((()=>{const t=e("[data-setting='fdbgp_sheet_list']");t.find(`option[value="${a.sheet_name}"]`).length>0&&t.val(a.sheet_name).trigger("change")}),1500)}}saveWidgetState(e){try{const t=elementor.getPanelView().getCurrentPageView().model.get("id");this.widgetState[t]=e}catch(e){}}clearWidgetState(){this.widgetState={}}registerElementorHooks(){elementor.hooks.addAction("panel/open_editor/widget",(e=>{setTimeout((()=>{const t=e.$el.find("[data-setting='fdbgp_spreadsheetid']"),s=e.$el.find("[data-setting='fdbgp_sheet_list']"),a=t.val(),n=s.val();if(a&&""!==a||n&&""!==n)a&&"new"!==a&&(s.find("option").length<=2?t.trigger("change"):this.checkSheetContent(s));else{const e=this.getCacheKey(),a=localStorage.getItem(e);if(a)try{const e=JSON.parse(a);if(e.id&&0===t.find(`option[value="${e.id}"]`).length){const s=t.find('option[value="new"]');s.remove();const a=document.createElement("option");a.value=e.id,a.text=e.name,t.append(a),t.append(s)}e.id&&(e.sheet_name&&s.data("auto-select",e.sheet_name),t.val(e.id).trigger("change"))}catch(e){console.log("FDBGP: Error restoring from cache:",e)}}}),1e3)})),elementor.channels?.editor&&elementor.channels.editor.on("change",(()=>{setTimeout((()=>{if(this.isRestoring)return;const s=e(".elementor-control-fdbgp_sheet_list select:visible"),a=e(".elementor-control-fdbgp_spreadsheetid select:visible");if(s.length&&a.length)try{const e=elementor.getPanelView()?.getCurrentPageView?.().model.get("id");let n=t.fdbgpWidgetState?.[e];if(!n){const e=this.getCacheKey(),t=localStorage.getItem(e);if(t)try{const e=JSON.parse(t);n={spreadsheet:e.id,sheet:e.sheet_name}}catch(e){}}if(n){const e=a.val();s.val();if((!e||""===e)&&n.spreadsheet){if(0===a.find(`option[value="${n.spreadsheet}"]`).length){const e=localStorage.getItem(this.getCacheKey());if(e){const t=JSON.parse(e),s=a.find('option[value="new"]');s.remove();const n=document.createElement("option");n.value=t.id,n.text=t.name,a.append(n),a.append(s)}}return this.isRestoring=!0,n.sheet&&s.data("auto-select",n.sheet),a.val(n.spreadsheet).trigger("change"),void setTimeout((()=>{this.isRestoring=!1}),1e3)}if(n.sheet&&s.val()!==n.sheet){const e=s.find(`option[value="${n.sheet}"]`).length;!e&&a.val()?(this.isRestoring=!0,s.data("auto-select",n.sheet),a.trigger("change"),setTimeout((()=>{this.isRestoring=!1}),1e3)):e&&s.val(n.sheet).trigger("change")}}}catch(e){console.error("FDBGP: Error in change handler:",e),this.isRestoring=!1}}),300)}));const s=()=>{const e=this.getCacheKey();localStorage.removeItem(e)};t.addEventListener("beforeunload",(()=>{s()}))}startPollingFallback(){const t=performance.now(),s=setInterval((()=>{const a=e(".elementor-control-fdbgp_spreadsheetid select:visible"),n=e(".elementor-control-fdbgp_sheet_list select:visible");a.length&&n.length&&a.val()&&(clearInterval(s),a.trigger("change")),performance.now()-t>2e4&&clearInterval(s)}),1e3)}}e(t).on("load",(()=>{t.FDBGP_Editor=new s})),e(t).on("load",(()=>{if("undefined"!=typeof elementor&&elementor.modules&&elementor.modules.controls){const t=elementor.modules.controls.BaseData.extend({onReady:function(){this.ui.select.length>0&&this.ui.select.select2({placeholder:"Select fields",allowClear:!0,width:"100%"}),this.updateOptions(),this.container.settings.has("form_fields")&&this.listenTo(this.container.settings.get("form_fields"),"add remove change",this.updateOptions)},updateOptions:function(){const t=this.container.settings.get("form_fields"),s=this.ui.select,a=this.getControlValue(),n=this.model.get("options");s.empty(),t&&t.each((e=>{const t=e.get("custom_id");let a=e.get("field_label");a||(a=t);const n=`${a} (${t})`;s.append(new Option(n,t,!1,!1))})),n&&e.each(n,((e,t)=>{s.append(new Option(t,e,!1,!1))})),a&&s.val(a),s.trigger("change")},onBeforeDestroy:function(){this.ui.select.data("select2")&&this.ui.select.select2("destroy")}});elementor.addControlView("fdbgp_dynamic_select2",t)}}))})(jQuery,window);